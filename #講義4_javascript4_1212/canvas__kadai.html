<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="css/fukushi.css">
    <title>ç­‹ãƒˆãƒ¬ãŠçµµã‹ãã‚¢ãƒ—ãƒª</title>
</head>

<body>
    <div class="tittle">
        ğŸ’ªã•ãã€ã¿ã‚“ãªä»Šæ—¥ã‚‚é›ãˆãŸãŠäº’ã„ã‚’è®ƒãˆã‚ˆã†ğŸ’ª
    </div>

    <h1>ä»Šæ—¥ã®æˆæœã‚’ã‚¢ãƒƒãƒ—ã—ã‚ˆã†ï¼</h1>

    <input type="color" id="color">
    <input type="range" id="range" min="0" max="100" value="10">

    <!-- ç”»åƒã‚’èª­ã¿è¾¼ã¿ -->
    <input type="file">
    <!-- â†“ã‚’ã‚³ãƒ¡ãƒ³ãƒˆOUTã—ã¦canvas id="drowarea"ã‚’æ´»ã‹ã™ -->
    <!-- <canvas id="canvas"></canvas> -->
    <!-- ç”»åƒã‚’èª­ã¿è¾¼ã¿ -->

    <section>

        <nav>
            <!-- ç·šã®è‰²ã‚’å¤‰æ›´ã™ã‚‹HTMLè¦ç´  -->

            <!-- ç·šã®å¤ªã•ã‚’å¤‰æ›´ã™ã‚‹HTMLè¦ç´  -->

            <button id="clear_btn">ã‚¯ãƒªã‚¢ãƒ¼</button>
        </nav>
        <canvas id="drowarea" width="800" height="300" style="border:1px solid blue;"></canvas>
    </section>

    <!-- ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ -->
    <a id="download" href="#" download="canvas.jpg">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
    <!-- ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ -->

    <h1>ä»Šæ—¥ã®æˆæœã‚’å…±æœ‰ã—ã‚ˆã†ï¼</h1>
    <div>
        <ul>
            <li class="imgs" data-img="0"><img src="imgs/buke.png" width="200"></li>
            <li class="imgs" data-img="1"><img src="imgs/tuku.jpg" width="200"></li>
            <li class="imgs" data-img="2"><img src="imgs/caram.png" width="200"></li>
        </ul>
        <div>
            éƒ¨ä½ï¼š<input type="text" id="uname">
        </div>
        <div>
            <textarea id="text" cols="30" rows="10">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å†…å®¹</textarea>
            <button id="send">é€ä¿¡</button>
        </div>
        <div id="output" style="height:150px; width: 700px; overflow:auto;"></div>
    </div>

    <!-- JQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<!-- JQuery -->


<!--** ä»¥ä¸‹Firebase **-->
<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/8.1.2/firebase.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->


    <script src="js/jquery-2.1.3.min.js"></script>
    <script>

// ç”»åƒã‚’èª­ã¿è¾¼ã¿
    const canvas = document.getElementById("drowarea")

    document.querySelector('input[type="file"]').onchange = function() {
        let img = this.files[0]
        let reader = new FileReader()
        reader.readAsDataURL(img)
        reader.onload = function() {
            drawImage(reader.result)
        }
    }

    function drawImage(url) {
        let ctx = canvas.getContext('2d')
        let image = new Image()
        image.src = url
        image.onload = () => {
            canvas.width = image.width
            canvas.height = image.height
            ctx.drawImage(image, 0, 0)
        }
    }
// ç”»åƒã‚’èª­ã¿è¾¼ã¿

$("#color").on("change",function(){ //ãƒã‚§ãƒ³ã‚¸ã‚¤ãƒ™ãƒ³ãƒˆã€‚clickã˜ã‚ƒãªãchange
    const c = $(this).val(); //è‰²ã®å–å¾—ã€‚thisã¯ç›´å‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‚ç…§ã™ã‚‹
    color=c;
});

$("#range").on("change",function(){
        const r = $(this).val(); //ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã‚’å–å¾—
        bold_line=r;
    });

        //åˆæœŸåŒ–(å¤‰æ•°letã§å®£è¨€)
        let canvas_mouse_event = false; //ã‚¹ã‚¤ãƒƒãƒ [ true=ç·šã‚’å¼•ã, false=ç·šã¯å¼•ã‹ãªã„ ]  ï¼Šï¼Šï¼Š
        let oldX = 0; //ï¼‘ã¤å‰ã®åº§æ¨™ã‚’ä»£å…¥ã™ã‚‹ãŸã‚ã®å¤‰æ•°
        let oldY = 0; //ï¼‘ã¤å‰ã®åº§æ¨™ã‚’ä»£å…¥ã™ã‚‹ãŸã‚ã®å¤‰æ•°
        let bold_line = 3; //ãƒ©ã‚¤ãƒ³ã®å¤ªã•ã‚’ã“ã“ã§æŒ‡å®š
        let color = "#ccc"; //ãƒ©ã‚¤ãƒ³ã®è‰²ã‚’ã“ã“ã§æŒ‡å®š

        //------------------------------------------------
        //const can = $("#drowarea")[0]; //CanvasElement
        //const ctx = can.getContext("2d"); //æç”»ã™ã‚‹ãŸã‚ã®æº–å‚™ï¼
        //------------------------------------------------
        //ä¸Š2ã¤ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¨˜è¿°ã—ã¾ã™ã€‚
        const can = $("#drowarea")[0]; //CanvasElement
        const ctx = can.getContext("2d"); //æç”»ã™ã‚‹ãŸã‚ã®æº–å‚™ï¼




        //mousedownï¼šãƒ•ãƒ©ã‚°ã‚’True
        //-----------------------------------------------
        //oldX = e.offsetX;       //MOUSEDOWNã—ãŸXæ¨ªåº§æ¨™å–å¾—
        //oldY = e.offsetY; //MOUSEDOWN Yé«˜ã•åº§æ¨™å–å¾—
        //canvas_mouse_event=true;
        //-----------------------------------------------
        //ä¸Š5ã¤ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¨˜è¿°ã—ã¾ã™ã€‚
        $(can).on("mousedown",function(e){
            console.log(e);
            oldX = e.offsetX; //ç¾åœ¨åœ°ç‚¹Xã‚’oldXã«ä»£å…¥
            oldY = e.offsetY; //ç¾åœ¨åœ°ç‚¹Yã‚’oldYã«ä»£å…¥
            canvas_mouse_event = true; //ã‚¹ã‚¤ãƒƒãƒã‚ªãƒ³ã€‚æ›¸ãã
        });
        

        //mousemoveï¼šãƒ•ãƒ©ã‚°ãŒTrueã ã£ãŸã‚‰æã â€»eï¼šã‚¤ãƒ™ãƒ³ãƒˆå¼•æ•°å–å¾—
        //----------------------------------------------
        //  if(canvas_mouse_event==true){
        //      const px = e.offsetX;
        //      const py = e.offsetY;
        //      ctx.strokeStyle = color;
        //      ctx.lineWidth = bold_line;
        //      ctx.beginPath();
        //      ctx.lineJoin= "round";
        //      ctx.lineCap = "round";
        //      ctx.moveTo(oldX, oldY);
        //      ctx.lineTo(px, py);
        //      ctx.stroke();
        //      oldX = px;
        //      oldY = py;
        //  }
        $(can).on("mousemove",function(e){
            console.log(e.offsetX);
            if(canvas_mouse_event==true){
                const px = e.offsetX;
                const py = e.offsetY;
                ctx.strokeStyle = color;
                ctx.lineWidth = bold_line;
                ctx.beginPath();
                ctx.lineJoin= "round";
                ctx.lineCap = "round";
                ctx.moveTo(oldX, oldY);
                ctx.lineTo(px, py);
                ctx.stroke();
                oldX = px; //ç¾åœ¨åœ°ç‚¹ã‚’åŸºç‚¹ã«å…¥ã‚Œæ›¿ãˆ
                oldY = py; //ç¾åœ¨åœ°ç‚¹ã‚’åŸºç‚¹ã«å…¥ã‚Œæ›¿ãˆ
            }
        });

        //mouseupï¼šãƒ•ãƒ©ã‚°ã‚’false
        //------------------------------------------------
        //    canvas_mouse_event=false;
        //------------------------------------------------
$(can).on("mouseup",function(){
    canvas_mouse_event=false;
});

// â†“è©¦ã—ãŸã‘ã©å‹•ã‹ãªã„ï¼Ÿæœ¬å½“ã«å‹•ãï¼Ÿ
// $(can).on("mousedoun",function(){
//     canvas_mouse_event=false;
// });

        //#clear_btnï¼šã‚¯ãƒªã‚¢ãƒ¼ãƒœã‚¿ãƒ³Action
        //-----------------------------------------------------------------
        //    ctx.beginPath();
        //    ctx.clearRect(0, 0, can.width, can.height);
        //-----------------------------------------------------------------

$("#clear_btn").on("click",function(){
    ctx.beginPath();
    ctx.clearRect(0, 0, can.width, can.height);
});

$(can).on("mouseout",function(){ //ä¸€ç•ªä¸Šã«å…¥ã‚Œã¡ã‚ƒãƒ€ãƒ¡ã€‚ä»–ã®jsã®é‚ªé­”ã™ã‚‹
    canvas_mouse_event=false;
    console.log("mouseout");
});

// ç”»åƒã‚’ä¿å­˜
    $("#download").click(function(){
    drowarea = document.getElementById('drowarea'); //ã“ã“ã§canvasã®IDã‚’æŒ‡å®šã—ãªã„ã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œãªã„
    var base64 = canvas.toDataURL("image/jpeg");
    document.getElementById("download").href = base64;
    });
// ç”»åƒã‚’ä¿å­˜

    // Your web app's Firebase configuration
    var firebaseConfig = {
        apiKey: "AIzaSyCr-WyBE5Ti2RQWKIyfW8Usuu0jerVghE8",
        authDomain: "unit1-1f516.firebaseapp.com",
        projectId: "unit1-1f516",
        storageBucket: "unit1-1f516.appspot.com",
        messagingSenderId: "376770248075",
        appId: "1:376770248075:web:67571b165835f30e2c038e"
        };
    // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        const ref = firebase.database().ref();
    // ref()ã®ä¸­ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’æ›¸ãã¨ãã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã§ä¿å­˜ã§ãã‚‹



    // ã‚¢ã‚¤ã‚³ãƒ³å‡¦ç†
    let d=0;
    const img = ["buke.png","tuku.jpg","caram.png"];
    $(".imgs").on("click",function(){
        d = $(this).attr("data-img"); //attrã‚’fttrã£ã¦æ‰“ã¡é–“é•ã„(T_T)
    });



    // é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
        $("#send").on("click", function(){
            // æ—¥æ™‚ã®å–å¾—
                let date = new Date();
                function sampleDate(date, format) {
                    format = format.replace(/YYYY/, date.getFullYear());
                    format = format.replace(/MM/, date.getMonth() + 1);
                    format = format.replace(/DD/, date.getDate());
                    format = format.replace(/h/g, date.getHours());
                    format = format.replace(/m/g, date.getMinutes());
                    format = format.replace(/s/g, date.getSeconds());
                    return format;
                }
            let postday = sampleDate(date, 'YYYY-MM-DD-h-m-s');

                const uname = $("#uname").val();
                const text  = $("#text").val();
                const msg   = {
                uname: uname,   //é€ä¿¡å:å€¤
                text: text,     //é€ä¿¡å:å€¤
                date: postday,
                icon: d
                };
                ref.push(msg);    //ã‚µãƒ¼ãƒãƒ¼ã«Push
        });



    // å—ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
        ref.on("child_added",function(data){
            const v = data.val();
            const k = data.key; //æ›´æ–°ã¨å‰Šé™¤ã«å¿…è¦ã‚‰ã—ã„
            const h = '<p><img src="imgs/'+img[v.icon]+'" width="50">'+v.date+'<br>'+v.uname+'<br>'+v.text+'</p>'; 
            //'<p>'ã®>ã®ã™ãå¾Œã‚ã«å…¥ã‚Œãªã„ã¨ãƒ€ãƒ¡ã€‚>'ã®å¾Œã«å…¥ã‚Œã¦ãŸ
            $("#output").append(h);
            const tdiv = document.getElementById("output"); //ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸‹éƒ¨ã¸ç§»å‹•
            tdiv.scrollTop = tdiv.scrollHeight;
        });

    </script>
</body>

</html>